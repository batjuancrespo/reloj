<!DOCTYPE html>
<html lang="es" style="height: 100%;">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <!-- Meta tag para que Chrome lo abra en modo app -->
    <meta name="mobile-web-app-capable" content="yes">
    <title>Reloj y Tiempo en Selaya</title>
    <!-- Librería Moment.js para manejar fechas y horas -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/locale/es.js"></script>
    
    <style>
        /* RESET BÁSICO Y ESTILOS GLOBALES */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            -webkit-tap-highlight-color: transparent; /* Evita el brillo azul al tocar en WebViews */
        }

        html, body {
            height: 100%;
            overflow: hidden; /* Evita el scroll no deseado */
        }

        body {
            font-family: sans-serif; /* Fuentes del sistema: más rápidas y compatibles */
            background: #000;
            color: white;
            display: flex;
            flex-direction: column;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* --- CONTENEDOR PRINCIPAL --- */
        .container {
            display: flex;
            flex-direction: column;
            flex-grow: 1; /* Ocupa todo el espacio vertical disponible */
            padding: 10px;
        }

        /* --- SECCIÓN SUPERIOR: RELOJ Y TIEMPO ACTUAL --- */
        .main-display {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 10px;
        }

        #current-weather {
            text-align: center;
            font-size: 1.2em;
            flex: 1;
        }

        #current-weather img {
            width: 60px;
            height: 60px;
        }

        #clock {
            font-size: 7em; /* Un poco más pequeño para asegurar que quepa en todas las pantallas */
            font-weight: bold;
            text-align: center;
            flex-shrink: 0; /* Evita que el reloj se encoja si no hay espacio */
            padding: 0 15px;
        }

        #date-temp {
            text-align: center;
            font-size: 1.2em;
            flex: 1;
        }

        #current-temp {
            font-size: 2em;
            margin-bottom: 5px;
        }

        #current-date {
            font-size: 1em;
            color: #ccc;
        }
        
        /* --- SECCIÓN MEDIA: PRONÓSTICO Y ALARMA --- */
        .middle-section {
            display: flex;
            height: 140px; /* Altura fija para estabilidad del diseño */
        }

        #weather {
            flex-basis: 50%;
            margin-right: 10px; /* Reemplazo de 'gap' para compatibilidad */
            background: rgba(255, 255, 255, 0.05);
            padding: 10px;
            border-radius: 10px;
            display: flex;
            justify-content: space-between;
        }

        .weather-card {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            padding: 5px;
        }

        .weather-card .day-name { font-size: 1em; font-weight: bold; }
        .weather-card img { width: 40px; height: 40px; margin: 5px 0; }
        .weather-card .temp { font-size: 1.2em; font-weight: bold; }

        .alarm-container {
            flex-basis: 50%;
            margin-left: 10px; /* Reemplazo de 'gap' */
            background: rgba(255, 255, 255, 0.05);
            padding: 10px;
            border-radius: 10px;
            display: flex;
            flex-direction: column;
        }

        .alarm-controls { display: flex; flex-direction: column; }
        .time-picker-container { display: flex; }
        .slider-container { flex-grow: 1; text-align: center; }
        .slider-container div { font-size: 0.9em; margin-bottom: 2px;}
        .time-slider { width: 95%; }
        .time-controls { display: flex; flex-direction: column; justify-content: center; margin-left: 10px; }
        .time-display { font-size: 1.8em; font-weight: bold; text-align: center; margin-bottom: 5px; }
        .alarm-button { padding: 8px; font-size: 0.9em; border-radius: 8px; border: none; background: #2196F3; color: white; }
        .alarm-list { flex-grow: 1; display: flex; justify-content: center; align-items: center; }
        .alarm-item { display: flex; justify-content: space-between; align-items: center; font-size: 1.5em; width: 100%; }
        .alarm-item span { margin-right: 15px; }
        .alarm-item button { padding: 8px; font-size: 0.8em; background: rgba(255, 0, 0, 0.5); color: white; border: none; border-radius: 8px; }

        /* --- SECCIÓN INFERIOR: NOTICIAS --- */
        .news-panels {
            display: flex;
            margin-top: 15px;
            height: 100px; /* Altura fija para estabilidad */
        }

        .news-container {
            flex-basis: 50%;
            background: rgba(255, 255, 255, 0.05);
            padding: 10px 15px;
            border-radius: 10px;
            position: relative;
            overflow: hidden;
        }
        .news-container:first-child { margin-right: 10px; /* Reemplazo de 'gap' */ }
        .news-container:last-child { margin-left: 10px; /* Reemplazo de 'gap' */ }
        
        .news-container h3 {
            font-size: 1em;
            margin-bottom: 8px;
        }
        .news-item {
            position: absolute;
            opacity: 0;
            transition: opacity 0.5s;
        }
        .news-item.active {
            opacity: 1;
        }
        .news-item a {
            color: white;
            text-decoration: none;
            font-size: 1em;
        }

        /* --- ESTADO DE ALARMA --- */
        @keyframes alarm-flash {
            50% { background: rgba(255, 0, 0, 0.4); }
        }
        .alarming {
            animation: alarm-flash 1s infinite;
        }

        /* --- MODO FOTO (Opcional) --- */
        .photo-frame-mode .container, .photo-frame-mode .mode-switch {
            display: none;
        }
        #photoFrame {
            display: none; /* Se activa por JS */
            width: 100%;
            height: 100%;
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center center;
            background-color: black;
        }
        .photo-frame-mode #photoFrame {
            display: block;
        }
        .mode-switch { position: fixed; top: 10px; right: 10px; z-index: 1000; }
        .switch { position: relative; display: inline-block; width: 50px; height: 28px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(255,255,255,0.2); transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 22px; width: 22px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: #2196F3; }
        input:checked + .slider:before { transform: translateX(22px); }

    </style>
</head>
<body ontouchstart=""> <!-- 'ontouchstart' activa los :active styles en WebViews antiguos -->
    
    <!-- Interruptor para el modo foto -->
    <div class="mode-switch">
        <label class="switch">
            <input type="checkbox" id="modeToggle">
            <span class="slider"></span>
        </label>
    </div>

    <!-- Contenedor principal de la interfaz -->
    <div class="container">
        <!-- SECCIÓN SUPERIOR -->
        <div class="main-display">
            <div id="current-weather"></div>
            <div id="clock">00:00</div>
            <div id="date-temp">
                <div id="current-temp">--°C</div>
                <div id="current-date">Cargando...</div>
            </div>
        </div>
        <!-- SECCIÓN MEDIA -->
        <div class="middle-section">
            <div id="weather"></div>
            <div class="alarm-container">
                <div class="alarm-controls">
                    <div class="time-picker-container">
                        <div class="slider-container">
                            <div>Horas</div>
                            <input type="range" min="0" max="23" value="7" class="time-slider" id="hourSlider">
                            <div>Minutos</div>
                            <input type="range" min="0" max="59" value="30" class="time-slider" id="minuteSlider">
                        </div>
                        <div class="time-controls">
                            <div class="time-display" id="selectedTime">07:30</div>
                            <button class="alarm-button" id="setAlarm">Fijar</button>
                        </div>
                    </div>
                </div>
                <div class="alarm-list" id="alarmList"></div>
            </div>
        </div>
        <!-- SECCIÓN INFERIOR -->
        <div class="news-panels">
            <div class="news-container" id="generalNews">
                <h3>Noticias Generales</h3>
            </div>
            <div class="news-container" id="sportsNews">
                <h3>Noticias Deportivas</h3>
            </div>
        </div>
    </div>
    
    <!-- Contenedor para el modo Marco de Fotos -->
    <div id="photoFrame"></div>

<script>
// ----- INICIO DEL SCRIPT -----

moment.locale('es');

// Función de utilidad para asegurar dos dígitos (compatible con navegadores antiguos)
function pad(num) {
    return ('0' + num).slice(-2);
}

// Traducciones para el tiempo de OpenWeatherMap
const weatherTranslations = { 'clear sky': 'Despejado', 'few clouds': 'Pocas nubes', 'scattered clouds': 'Nubes dispersas', 'broken clouds': 'Nuboso', 'shower rain': 'Lluvia débil', 'rain': 'Lluvia', 'thunderstorm': 'Tormenta', 'snow': 'Nieve', 'mist': 'Niebla', 'overcast clouds': 'Muy nuboso', 'light rain': 'Lluvia ligera' };

// --- FUNCIONES PRINCIPALES ---

function updateClock() {
    const now = moment();
    document.getElementById('clock').textContent = now.format('HH:mm');
    document.getElementById('current-date').textContent = now.format('dddd, D [de] MMMM');
}

// CAMBIO: Reescrito sin async/await, usando promesas con .then() para máxima compatibilidad
function getWeather() {
    const lat = 43.2;
    const lon = -3.8;
    const apiKey = '56463b4abd4cb828b6db3c8395dcedbc'; // Reemplaza con tu propia clave si es necesario
    
    fetch('https://api.openweathermap.org/data/2.5/forecast?lat=' + lat + '&lon=' + lon + '&appid=' + apiKey + '&units=metric&cnt=32')
        .then(function(response) {
            if (!response.ok) { throw new Error('Network response was not ok'); }
            return response.json();
        })
        .then(function(data) {
            const currentWeather = data.list[0];
            const currentIcon = currentWeather.weather[0].icon;
            const currentDescription = weatherTranslations[currentWeather.weather[0].description.toLowerCase()] || currentWeather.weather[0].description;
            document.getElementById('current-weather').innerHTML = '<img src="https://openweathermap.org/img/wn/' + currentIcon + '@2x.png" alt="' + currentDescription + '"><div>' + currentDescription + '</div>';
            document.getElementById('current-temp').textContent = Math.round(currentWeather.main.temp) + '°C';

            let weatherHTML = '';
            const forecasts = [];
            for (var i = 1; i <= 3; i++) {
                const targetDate = moment().add(i, 'days').startOf('day');
                const dayForecast = data.list.find(function(item) {
                    return moment(item.dt * 1000).isSame(targetDate, 'day') && moment(item.dt * 1000).hour() >= 12;
                });
                if (dayForecast) forecasts.push(dayForecast);
            }

            forecasts.forEach(function(day) {
                const dayName = moment(day.dt * 1000).format('ddd');
                const icon = day.weather[0].icon;
                const description = weatherTranslations[day.weather[0].description.toLowerCase()] || day.weather[0].description;
                weatherHTML +=
                    '<div class="weather-card">' +
                    '<div class="day-name">' + dayName + '</div>' +
                    '<img src="https://openweathermap.org/img/wn/' + icon + '.png" alt="' + description + '">' +
                    '<div class="temp">' + Math.round(day.main.temp) + '°C</div>' +
                    '</div>';
            });
            document.getElementById('weather').innerHTML = weatherHTML;
        })
        .catch(function(error) {
            console.error('Error fetching weather:', error);
            document.getElementById('weather').innerHTML = '<p style="font-size: 0.8em; text-align: center;">Error al cargar el tiempo</p>';
        });
}

// CAMBIO: Reescrito sin async/await y usando Promise.all para manejar múltiples peticiones
function createNewsRotator(containerId, feeds) {
    const container = document.getElementById(containerId);
    let allNews = [];
    let currentIndex = 0;

    function fetchNews() {
        console.log('Fetching news for ' + containerId);
        const promises = feeds.map(function(feed) {
            return fetch('https://api.rss2json.com/v1/api.json?rss_url=' + encodeURIComponent(feed))
                .then(function(response) { return response.json(); })
                .catch(function(e) {
                    console.error('Failed to fetch ' + feed, e);
                    return null; // Devuelve null en caso de error para no romper Promise.all
                });
        });

        Promise.all(promises).then(function(results) {
            const fetchedItems = [];
            results.forEach(function(data) {
                if (data && data.status === 'ok' && data.items) {
                    data.items.slice(0, 5).forEach(function(item) {
                        fetchedItems.push({ title: item.title, link: item.link });
                    });
                }
            });
            if (fetchedItems.length > 0) {
                allNews = fetchedItems;
                currentIndex = 0;
                showNextNews(); // Muestra la primera noticia tan pronto como se cargan
            }
        });
    }

    function showNextNews() {
        if (allNews.length === 0) return;
        
        const oldNews = container.querySelector('.news-item');
        if(oldNews) container.removeChild(oldNews);

        const article = allNews[currentIndex];
        const newsItem = document.createElement('div');
        newsItem.className = 'news-item';
        newsItem.innerHTML = '<a href="' + article.link + '" target="_blank">' + article.title + '</a>';
        container.appendChild(newsItem);

        void newsItem.offsetWidth; // Truco para forzar reflow y que la animación funcione
        newsItem.classList.add('active');
        
        currentIndex = (currentIndex + 1) % allNews.length;
    }

    fetchNews();
    setInterval(fetchNews, 600000); // Actualiza las noticias cada 10 minutos
    setInterval(showNextNews, 8000); // Rota a la siguiente noticia cada 8 segundos
}

// ----- SISTEMA DE ALARMA (código compatible) -----
let alarms = [];
const alarmSound = new Audio('https://assets.mixkit.co/sfx/preview/mixkit-alarm-digital-clock-beep-989.mp3');
alarmSound.loop = true;

function checkAlarms() {
    const currentTime = moment().format('HH:mm');
    alarms.forEach(function(alarm, index) {
        if (alarm.time === currentTime && !alarm.triggered) {
            alarms[index].triggered = true;
            document.body.classList.add('alarming');
            alarmSound.play().catch(function(error) {
                console.error("Audio play failed:", error);
            });
        }
    });
}
function stopAlarm() {
    alarmSound.pause();
    alarmSound.currentTime = 0;
    document.body.classList.remove('alarming');
    alarms = alarms.filter(function(alarm) { return !alarm.triggered; });
    updateAlarmList();
}
function addAlarm(time) {
    if (alarms.length === 0) { // Solo permite una alarma a la vez para simplificar
        alarms.push({ time: time, triggered: false });
        updateAlarmList();
    }
}
function removeAlarm(index) {
    alarms.splice(index, 1);
    updateAlarmList();
}
function updateAlarmList() {
    const alarmList = document.getElementById('alarmList');
    const alarmControls = document.querySelector('.alarm-controls');
    if (alarms.length > 0) {
        alarmControls.style.display = 'none';
        alarmList.innerHTML = alarms.map(function(alarm, index) {
            return '<div class="alarm-item">' +
                   '<span>' + alarm.time + '</span>' +
                   '<button ontouchend="removeAlarm(' + index + ')" onclick="removeAlarm(' + index + ')">Cancelar</button>' +
                   '</div>';
        }).join('');
    } else {
        alarmControls.style.display = 'flex';
        alarmList.innerHTML = '';
    }
}
function updateTimeDisplay() {
    const hours = pad(document.getElementById('hourSlider').value);
    const minutes = pad(document.getElementById('minuteSlider').value);
    document.getElementById('selectedTime').textContent = hours + ':' + minutes;
}

// ----- EVENT LISTENERS (manejadores de eventos) -----

document.getElementById('hourSlider').addEventListener('input', updateTimeDisplay);
document.getElementById('minuteSlider').addEventListener('input', updateTimeDisplay);
document.getElementById('setAlarm').addEventListener('click', function() {
    const hours = pad(document.getElementById('hourSlider').value);
    const minutes = pad(document.getElementById('minuteSlider').value);
    addAlarm(hours + ':' + minutes);
});
document.body.addEventListener('click', function() {
    if (document.body.classList.contains('alarming')) stopAlarm();
});

// Listener para el modo foto
document.getElementById('modeToggle').addEventListener('change', function(e) {
    const photoMode = e.target.checked;
    document.body.classList.toggle('photo-frame-mode', photoMode);
    
    if (photoMode) {
        const photos = [
            'https://source.unsplash.com/random/1024x600?nature',
            'https://source.unsplash.com/random/1024x600?water',
            'https://source.unsplash.com/random/1024x600?mountain',
            'https://source.unsplash.com/random/1024x600?sky'
        ];
        const photoFrame = document.getElementById('photoFrame');
        let currentIndex = 0;
        
        function showNextPhoto() {
            if (!document.body.classList.contains('photo-frame-mode')) return;
            photoFrame.style.backgroundImage = 'url(' + photos[currentIndex] + ')';
            currentIndex = (currentIndex + 1) % photos.length;
        }
        
        showNextPhoto();
        window.photoInterval = setInterval(showNextPhoto, 15000);
    } else {
        if (window.photoInterval) clearInterval(window.photoInterval);
    }
});

// ----- INICIALIZACIÓN DE LA APLICACIÓN -----
function init() {
    updateClock();
    setInterval(updateClock, 15000); // No es necesario actualizar el reloj cada segundo
    setInterval(checkAlarms, 1000); // La alarma sí debe comprobarse cada segundo

    getWeather();
    setInterval(getWeather, 1800000); // Actualiza el tiempo cada 30 minutos

    createNewsRotator('generalNews', [
        'https://e00-elmundo.uecdn.es/elmundo/rss/portada.xml',
        'https://www.eldiariomontanes.es/rss/2.0/?section=ultima-hora'
    ]);
    createNewsRotator('sportsNews', [
        'https://e00-marca.uecdn.es/rss/futbol/primera-division.xml',
        'https://www.eldiariomontanes.es/rss/2.0/?section=deportes'
    ]);

    updateTimeDisplay();
    updateAlarmList();

    console.log("Smart Clock Initialized");
}

init();

</script>
</body>
</html>
